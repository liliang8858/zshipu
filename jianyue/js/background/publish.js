try{let sendArticleBaseUrl="https://www.8qwe5.com",stateKey={},resetTempCookies=[],getTasktimer,progress=0;function getProgress(){return progress}function publishArticle(){clearInterval(getTasktimer),getTasktimer=setInterval(()=>{getTasksData()},2e3)}function getTasksData(){console.log("进入新任务"),$.ajax({url:`${sendArticleBaseUrl}/s/httptask/loadHttpTask`,type:"GET",success:e=>{console.log(e),e.hasOwnProperty("data")?(setPopupProgress(progress=0),clearInterval(getTasktimer),e.data=JSON.parse(decrypt(e.data)),console.log("原数据"),console.log(JSON.parse(JSON.stringify(e.data))),stateKey[e.data.serverTime]={i:0,ii:0,taskIDArr:[]},teaLog(`发文数据:${JSON.stringify(e.data)}`),setTimeout(()=>{fakeLoop(e)},200)):console.log("无任务，继续获取")}})}function fakeLoop(e){let a=e.data.tasks;stateKey[e.data.serverTime].taskIDArr=e.data.tasks.map(e=>e.taskId),forEachTasks(a[stateKey[e.data.serverTime].i],e,function(){clearCookie(a[stateKey[e.data.serverTime].i].domain).then(()=>{console.log("清除cookie完成"),teaLog("发文状态:清除cookie完成"),setCookie(a[stateKey[e.data.serverTime].i].domain,ckArrToObj(resetTempCookies)).then(()=>{console.log("设置cookie成功"),teaLog("发文状态:设置cookie成功"),stateKey[e.data.serverTime].i++,progress=100*Number((stateKey[e.data.serverTime].i/a.length).toFixed(2)),console.log(`进度:${progress}`),teaLog(`发文状态:设置进度${progress}`),console.log("----------------------task结束分割----------------------"),teaLog("发文状态:--end--"),setPopupProgress(progress),stateKey[e.data.serverTime].i<a.length?fakeLoop(e):(delete stateKey[e.data.serverTime],console.log("跳出所有循环"),teaLog("发文状态:跳出所有循环"))})})})}function forEachTasks(e,a,s){console.log("----------------------task开始分割----------------------"),teaLog("发文状态:--start--"),console.log("进入第一个循环"),teaLog("发文状态:进入第一个循环");let l=e.domain;chrome.cookies.getAll({url:l},function(t){resetTempCookies=t;let r=cookieToJson(e.cookie);0===t.length?setCookie(l,r).then(()=>{stateKey[a.data.serverTime].ii=0,taskLoop(e,!1,a,s)}):clearCookie(l).then(()=>{setCookie(l,r).then(()=>{stateKey[a.data.serverTime].ii=0,taskLoop(e,!1,a,s)})})})}function taskLoop(channel,breakChannelLoop,res,callback){async function requestLoop(channel,i,res,cb){let serverTime=res.data.serverTime,requestBody={},requestHeader={};if(breakChannelLoop)return void cb();console.log("进入第二个循环"),teaLog("发文状态:进入第二个循环");let channelTask=channel.requestUnits[i],nowTime=(new Date).getTime(),timeoutTime=channel.endTime;if(nowTime>timeoutTime)return console.log("timeout"),teaLog("发文状态:timeout"),void cb();if(channelTask.hasOwnProperty("urlRules"))for(let i=0;i<channelTask.urlRules.length;i++){let urlItem=channelTask.urlRules[i];if(0===urlItem.source){let e=channelTask.localParams.filter(e=>e.key===urlItem.key);channelTask.url=channelTask.url.replaceAll(urlItem.patten,e.value||"")}else{let tempRes=channel.requestUnits[urlItem.index].response;if("-1"===urlItem.key)if(urlItem.hasOwnProperty("jsMethod"))if("CRC32"===urlItem.jsMethod){let e=channel.requestUnits[urlItem.index].response,a=new Blob([e]);await blobToCrc32(a).then(e=>{channelTask.url=channelTask.url.replace(urlItem.patten,e)})}else if("MD5"===urlItem.jsMethod){let e=channel.requestUnits[urlItem.index].response,a=new Blob([e]);await hashMD5(a).then(e=>{channelTask.url=channelTask.url.replace(urlItem.patten,e)})}else if("SHA1"===urlItem.jsMethod){let e=channel.requestUnits[urlItem.index].response,a=new Blob([e]);await hashSHA1(a).then(e=>{channelTask.url=channelTask.url.replace(urlItem.patten,e)})}else console.log("暂无除了crc32其他转换方法！");else channelTask.url=channelTask.url.replace(urlItem.patten,tempRes);else{-1!=urlItem.key.indexOf("[")&&-1!=urlItem.key.indexOf("[")&&(urlItem.key=urlItem.key.replace(/'/g,""),urlItem.key=urlItem.key.replace(/"/g,""),urlItem.key=urlItem.key.split("["),urlItem.key=urlItem.key.join("$$"),urlItem.key=urlItem.key.replace(/]/g,"")),urlItem.key=urlItem.key.split("$$"),urlItem.key=keyTrans(urlItem.key);let waitReplace=eval(`tempRes${urlItem.key}`);channelTask.url=channelTask.url.replace(urlItem.patten,waitReplace)}}}if(channelTask.hasOwnProperty("delayTime")&&sleep(channelTask.delayTime),channelTask.hasOwnProperty("localParams"))for(let i=0;i<channelTask.localParams.length;i++){let localParams=channelTask.localParams[i];if(localParams.hasOwnProperty("rules"))for(let i=0;i<localParams.rules.length;i++){let rules=localParams.rules[i];if(-1===rules.index){let e=res.data.commonParams[rules.key];localParams.value=localParams.value.replace(rules.patten,e)}else if(0==rules.source){let e=channelTask.localParams.filter(e=>e.key===rules.key);localParams.value=localParams.value.replaceAll(rules.patten,e[0].value)}else if("-1"===rules.key)if(rules.hasOwnProperty("jsMethod"))if("CRC32"===rules.jsMethod){let e=channel.requestUnits[rules.index].response,a=new Blob([e]);await blobToCrc32(a).then(e=>{localParams.value=localParams.value.replaceAll(rules.patten,e)})}else"MD5"===rules.jsMethod?await hashMD5(channel.requestUnits[rules.index].url).then(e=>{localParams.value=localParams.value.replaceAll(rules.patten,e)}):"SHA1"===rules.jsMethod?await hashSHA1(channel.requestUnits[rules.index].url).then(e=>{localParams.value=localParams.value.replaceAll(rules.patten,e)}):console.log("暂无除了crc32其他转换方法！");else{let e=channel.requestUnits[rules.index].response;localParams.value=localParams.value.replaceAll(rules.patten,e)}else{let replaceEle=channel.requestUnits[rules.index].response;-1!=rules.key.indexOf("[")&&-1!=rules.key.indexOf("[")&&(rules.key=rules.key.replace(/'/g,""),rules.key=rules.key.replace(/"/g,""),rules.key=rules.key.split("["),rules.key=rules.key.join("$$"),rules.key=rules.key.replace(/]/g,"")),rules.key=rules.key.split("$$"),rules.key=keyTrans(rules.key);let waitReplace=eval(`replaceEle${rules.key}`);"object"==typeof waitReplace&&(waitReplace=JSON.stringify(waitReplace)),localParams.value=localParams.value.replaceAll(rules.patten,waitReplace)}}}if(channelTask.hasOwnProperty("params"))for(let i=0;i<channelTask.params.length;i++){let paramsItem=channelTask.params[i];if(paramsItem.hasOwnProperty("rules"))for(let i=0;i<paramsItem.rules.length;i++){let rules=paramsItem.rules[i];if(-1===rules.index){let e=res.data.commonParams[rules.key];paramsItem.value=paramsItem.value.replaceAll(rules.patten,e)}else if(0==rules.source){let e=channelTask.localParams.filter(e=>e.key===rules.key);paramsItem.value=paramsItem.value.replaceAll(rules.patten,e[0].value)}else if("-1"===rules.key){let e=channel.requestUnits[rules.index].response;paramsItem.value=e}else{let replaceEle=channel.requestUnits[rules.index].response;-1!=rules.key.indexOf("[")&&-1!=rules.key.indexOf("[")&&(rules.key=rules.key.split("["),rules.key=rules.key.join("$$"),rules.key=rules.key.replace("]","")),rules.key=rules.key.split("$$"),rules.key=keyTrans(rules.key);try{let waitReplace=eval(`replaceEle${rules.key}`);paramsItem.value=paramsItem.value.replaceAll(rules.patten,waitReplace)}catch(e){paramsItem.value=""}}}"-1"===paramsItem.key?requestBody=paramsItem.hasOwnProperty("value")?paramsItem.value:"":"string"==typeof paramsItem.value?requestBody[paramsItem.key]=paramsItem.hasOwnProperty("value")?paramsItem.value.replace(/{{}}\$nbsp;/g,"&nbsp;"):"":requestBody[paramsItem.key]=paramsItem.hasOwnProperty("value")?paramsItem.value:""}let waitPushData=0!==Object.keys(requestBody).length?requestBody:"";if(channelTask.hasOwnProperty("headers")){let isStringData=channelTask.headers.filter(e=>"JmJsonFormat"===e.key&&e.value);isStringData.length&&(Object.keys(waitPushData).forEach(function(key){try{waitPushData[key]=eval(waitPushData[key]),console.log("application/json把参数转成字符串"),teaLog("发文:application/json把参数转成字符串")}catch(e){}}),waitPushData=JSON.stringify(waitPushData))}if(channelTask.hasOwnProperty("headers"))for(let i=0;i<channelTask.headers.length;i++){let headerItem=channelTask.headers[i];if(headerItem.hasOwnProperty("rules"))for(let i=0;i<headerItem.rules.length;i++){let rules=headerItem.rules[i];if(-1===rules.index){let e=res.data.commonParams[rules.key];headerItem.value=headerItem.value.replace(rules.patten,e)}else if(0==rules.source){let e=channelTask.localParams.filter(e=>e.key===rules.key);headerItem.value=headerItem.value.replaceAll(rules.patten,e[0].value)}else if(1==rules.source)if("-1"===rules.key)if(rules.hasOwnProperty("jsMethod"))if("CRC32"===rules.jsMethod){let e=channel.requestUnits[rules.index].response,a=new Blob([e]);await blobToCrc32(a).then(e=>{headerItem.value=headerItem.value.replaceAll(rules.patten,e)})}else if("MD5"===rules.jsMethod){let e=channel.requestUnits[rules.index].response,a=new Blob([e]);await hashMD5(a).then(e=>{headerItem.value=headerItem.value.replaceAll(rules.patten,e)})}else if("SHA1"===rules.jsMethod){let e=channel.requestUnits[rules.index].response,a=new Blob([e]);await hashSHA1(a).then(e=>{headerItem.value=headerItem.value.replaceAll(rules.patten,e)})}else console.log("暂无除了crc32其他转换方法！");else{let e=channel.requestUnits[rules.index].response;localParams.value=localParams.value.replaceAll(rules.patten,e)}else{let replaceEle=channel.requestUnits[rules.index].response;-1!=rules.key.indexOf("[")&&-1!=rules.key.indexOf("[")&&(rules.key=rules.key.replace(/'/g,""),rules.key=rules.key.replace(/"/g,""),rules.key=rules.key.split("["),rules.key=rules.key.join("$$"),rules.key=rules.key.replace(/]/g,"")),rules.key=rules.key.split("$$"),rules.key=keyTrans(rules.key);let waitReplace=eval(`replaceEle${rules.key}`);"object"==typeof waitReplace&&(waitReplace=JSON.stringify(waitReplace)),headerItem.value=headerItem.value.replaceAll(rules.patten,waitReplace)}else if(2==rules.source){let replaceEle=channel.requestUnits[rules.index].resHeader;-1!=rules.key.indexOf("[")&&-1!=rules.key.indexOf("[")&&(rules.key=rules.key.replace(/'/g,""),rules.key=rules.key.replace(/"/g,""),rules.key=rules.key.split("["),rules.key=rules.key.join("$$"),rules.key=rules.key.replace(/]/g,"")),rules.key=rules.key.split("$$"),rules.key=keyTrans(rules.key);let waitReplace=eval(`replaceEle${rules.key}`);headerItem.value=headerItem.value.replaceAll(rules.patten,waitReplace)}else console.log("header处理中source判断失败"),teaLog("发文:header中source判断失败")}requestHeader[headerItem.key]=headerItem.value,delete requestHeader.Referer,delete requestHeader["User-Agent"],delete requestHeader.Origin,delete requestHeader.Host,delete requestHeader["Sec-Fetch-Mode"],delete requestHeader["Sec-Fetch-Site"],delete requestHeader.JmJsonFormat}let isStream=0;if(channelTask.hasOwnProperty("params")&&(isStream=channelTask.params.filter(e=>"FILE"===e.type)),isStream.length)if("formdata"===channelTask.responseType){console.log("百度 formdata");let e=new FormData;for(let a in requestBody)"object"==typeof requestBody[a]?e.append(a,new Blob([requestBody[a]],{type:"application/octet-stream"})):e.append(a,requestBody[a]);let a=new XMLHttpRequest;a.open(channelTask.method,`${channelTask.url}`),a.onload=function(){200==a.status&&(channelTask.resHeader=resHeaderToJson(a.getAllResponseHeaders())),cb()},a.send(e)}else{let e=new XMLHttpRequest;e.open(channelTask.method,`${channelTask.url}`,!0),channelTask.hasOwnProperty("headers")&&channelTask.headers.map(a=>{e.setRequestHeader(a.key,a.value)}),e.onload=function(){200==e.status&&(channelTask.resHeader=resHeaderToJson(e.getAllResponseHeaders())),cb()},e.send(requestBody)}else if("blob"===channelTask.responseType){let e=new XMLHttpRequest;e.open(channelTask.method,channelTask.url,!0),channelTask.hasOwnProperty("headers")&&channelTask.headers.map(a=>{e.setRequestHeader(a.key,a.value)}),e.responseType="blob",e.onload=function(){channelTask.response=this.response,cb()},e.send()}else $.ajax({type:channelTask.method||"get",url:`${channelTask.url}`,headers:requestHeader,contentType:channelTask.contentType||"application/x-www-form-urlencoded; charset=utf-8",async:!0,data:waitPushData,complete:function(e,a){channelTask.httpCode=e.status},error:function(e,a){teaArticlePublish(channel.taskId,channelTask.url,e.responseText,waitPushData,requestHeader),console.log("TASK发文结果: error"),teaLog("发文错误","发文结果: error"),channelTask.hasOwnProperty("continueRule")&&(statusInformHandle(channel.sendResult,e.responseText,e.status,channel.taskId,channelTask.ext,serverTime),breakChannelLoop=!0),i==channel.requestUnits.length-1&&(console.log("最后一个请求TASK发文结果: error"),teaLog("发文错误","发文结果: error"),statusInformHandle(channel.sendResult,e.responseText,e.status,channel.taskId,channelTask.ext,serverTime)),cb()},success:function(curRes,textStatus,resObj){if(teaArticlePublish(channel.taskId,channelTask.url,curRes,waitPushData,requestHeader),"string"==typeof curRes)try{curRes=JSON.parse(curRes)}catch(e){}if(channelTask.hasOwnProperty("continueRule")){let key=channelTask.continueRule.key,compare="";if(-1!=key.indexOf("[")&&-1!=key.indexOf("[")&&(key=key.replace(/'/g,""),key=key.replace(/"/g,""),key=key.split("["),key=key.join("$$"),key=key.replace(/]/g,"")),-1!==key.indexOf("$$")){key=key.split("$$"),key=keyTrans(key);try{compare=eval(`curRes${key}`)}catch(e){console.log("continueRule判断key值eval转换不成功。"),teaLog("发文错误","判断key值eval转换不成功")}}else try{compare=curRes[key]}catch(e){compare=""}let status=channelTask.continueRule.opt;0===status?channelTask.continueRule.value!=compare?(console.log("TASK发文结果: 返回值与预期不符"),teaLog("发文错误","返回值与预期不符"),statusInformHandle(channel.sendResult,curRes,200,channel.taskId,channelTask.ext,serverTime),breakChannelLoop=!0):(channelTask.response=curRes,i==channel.requestUnits.length-1&&(console.log("TASK发文结果: 最后一个发文"),teaLog("发文: 最后一个发文"),statusInformHandle(channel.sendResult,curRes,200,channel.taskId,channelTask.ext,serverTime)),channelTask.resHeader=resHeaderToJson(resObj.getAllResponseHeaders())):1===status?compare?(channelTask.response=curRes,i==channel.requestUnits.length-1&&(console.log("TASK发文结果: 最后一个发文"),teaLog("发文: 最后一个发文"),statusInformHandle(channel.sendResult,curRes,200,channel.taskId,channelTask.ext,serverTime)),channelTask.resHeader=resHeaderToJson(resObj.getAllResponseHeaders())):(statusInformHandle(channel.sendResult,curRes,200,channel.taskId,channelTask.ext,serverTime),console.log("TASK发文结果: 判断key值不存在"),teaLog("发文错误","判断key值不存在"),breakChannelLoop=!0):i==channel.requestUnits.length-1&&(console.log("TASK发文结果: 最后一个发文"),teaLog("发文: 最后一个发文"),statusInformHandle(channel.sendResult,curRes,200,channel.taskId,channelTask.ext,serverTime)),cb()}else channelTask.response=curRes,channelTask.resHeader=resHeaderToJson(resObj.getAllResponseHeaders()),i==channel.requestUnits.length-1&&(console.log("TASK发文结果: 最后一个发文"),teaLog("发文: 最后一个发文"),statusInformHandle(channel.sendResult,curRes,200,channel.taskId,channelTask.ext,serverTime)),cb()}})}requestLoop(channel,stateKey[res.data.serverTime].ii,res,function(){stateKey[res.data.serverTime].ii++,stateKey[res.data.serverTime].ii<channel.requestUnits.length?taskLoop(channel,breakChannelLoop,res,callback):(console.log("执行callback"),teaLog("发文状态:执行callback"),callback())})}function statusInformHandle(e,a,s,l,t,r){console.log(r),console.log("taskID:[35m「"+l+"」[0m"),teaLog(`发文sendresult:taskId${l}`),console.log("sendResult结果: "+JSON.stringify(a)),teaLog(`发文sendresult:结果${JSON.stringify(a)}`),void 0===a&&(a=""),$.ajax({type:`${e.method||"get"}`,url:`${e.url}`,async:!0,data:{taskId:l,result:JSON.stringify(a),httpState:s,ext:t},success:function(e){e.data?(console.log("task上报且有新任务"),teaLog("发文：task上报且有新任务"),publishArticle()):(console.log("task上报无新任务"),teaLog("发文：task上报无新任务"))}})}function sleep(e){let a=(new Date).getTime();for(;!((new Date).getTime()-a>e););}function cookieToJson(e){let a=e.split(";"),s={};return a.forEach(e=>{let a=e.split("=");s[a[0]]=a[1]}),s}function keyTrans(e){let a="";return e.forEach((e,s)=>{let l=e[0],t=e[e.lengsth-1];"["===l&&"]"===t?e&&(a+=`${e}`):e&&(a+=`['${e}']`)}),a}function decrypt(e){var a=CryptoJS.enc.Utf8.parse("5055248cb9f84065"),s=CryptoJS.AES.decrypt(e,a,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(s).toString()}function setPopupProgress(e){progress=e,0!==e&&100!==e?(chrome.browserAction.setBadgeText({text:"提示"}),chrome.browserAction.setBadgeBackgroundColor({color:"#fb4646"})):(chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setBadgeBackgroundColor({color:[0,0,0,0]}));var a=chrome.extension.getViews({type:"popup"});a[0]&&a[0].setProgress(e)}function resHeaderToJson(e){let a=e.replace(/[\n]/g,";;").split(";;"),s={};return a.forEach(e=>{let a=e.split(": ");0!==a[0].length&&(s[a[0]]=a[1])}),s}setPopupProgress(progress),String.prototype.splice=function(e,a){return this.slice(0,e)+a+this.slice(e)},String.prototype.replaceAll=function(e,a){return-1!==String(a).indexOf("$$")&&(a=String(a).replace(/\$\$/g,"$$$$$$$$")),e=e.replace(/[{$}]/g,"\\$&"),this.replace(new RegExp(e,"gm"),a)}}catch(e){teaLog("publish中catch",e)}